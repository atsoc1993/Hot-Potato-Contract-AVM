'use strict';

var jsonschema = require('jsonschema');
var boom = require('../util/boom.js');
var application_schema = require('./application.schema.json.js');
var arc56_schema = require('./arc56.schema.json.js');
var contract_schema = require('./contract.schema.json.js');
var appSpec = require('@algorandfoundation/algokit-utils/types/app-spec');

async function loadApplicationJson(appJsonPath) {
    const fs = await import('fs');
    if (!fs.existsSync(appJsonPath))
        boom.boom(`Could not find application.json file at ${appJsonPath}`);
    let jsonText = fs.readFileSync(appJsonPath, 'utf-8');
    let file = JSON.parse(jsonText);
    // Temporary to get backwards compatibility with TEALScript draft ARC-56
    if (!('contract' in file) /* ARC-56 */) {
        jsonText = jsonText.replace(/ype":\s*"bytes"/g, 'ype":"AVMBytes"').replace(/import\(.+?\)\./g, '');
        file = JSON.parse(jsonText);
    }
    return validateApplicationJson(file, appJsonPath);
}
function validateApplicationJson(json, appJsonPath) {
    if (typeof json !== 'object')
        boom.boom(`Could not parse ${appJsonPath} as JSON object`);
    /* eslint-disable @typescript-eslint/no-explicit-any */
    if ('contract' in json) {
        // ARC-32
        const arc32Validator = new jsonschema.Validator();
        arc32Validator.addSchema(contract_schema.default, '/contract.schema.json');
        const arc32Result = arc32Validator.validate(json, application_schema.default);
        if (!arc32Result.valid)
            boom.boom(`Could not parse ${appJsonPath} as ARC-32.\n${arc32Result}`);
        return appSpec.arc32ToArc56(json);
    }
    // ARC-56
    const arc56Validator = new jsonschema.Validator();
    const arc56Result = arc56Validator.validate(json, arc56_schema.default);
    if (!arc56Result.valid)
        boom.boom(`Could not parse ${appJsonPath} as ARC-56.\n${arc56Result}`);
    return json;
}

exports.loadApplicationJson = loadApplicationJson;
exports.validateApplicationJson = validateApplicationJson;
//# sourceMappingURL=load.js.map
